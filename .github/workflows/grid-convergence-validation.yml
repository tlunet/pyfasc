name: Grid Convergence Validation

# Trigger the workflow on push and pull requests
on:
  push:
    branches: [ main, develop ]
    paths:
      - 'codes/01_advDiffSolver/src/**'
      - 'codes/01_advDiffSolver/tests/run_validation.py'
      - 'codes/01_advDiffSolver/scripts/run_*_multi_*.py'
      - '.github/workflows/grid-convergence-validation.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'codes/01_advDiffSolver/src/**'
      - 'codes/01_advDiffSolver/tests/run_validation.py'
      - 'codes/01_advDiffSolver/scripts/run_*_multi_*.py'
      - '.github/workflows/grid-convergence-validation.yml'

jobs:
  validate-grid-convergence:
    runs-on: ubuntu-latest
    
    steps:
    # Checkout the repository
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # Need 2 commits to check diff
    
    # Detect changed files in src/
    - name: Detect changed source files
      id: detect-changes
      run: |
        echo "Detecting changed files in src/ directory..."
        
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          # For PRs, compare against base branch
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep '^codes/01_advDiffSolver/src/' || true)
        else
          # For pushes, compare with previous commit
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep '^codes/01_advDiffSolver/src/' || true)
        fi
        
        echo "Changed files:"
        echo "$CHANGED_FILES"
        
        # Check if any source files changed
        if [ -n "$CHANGED_FILES" ]; then
          echo "source_changed=true" >> $GITHUB_OUTPUT
          echo "Source files changed - validation will run"
        else
          echo "source_changed=false" >> $GITHUB_OUTPUT
          echo "No source files changed - skipping validation"
        fi
    
    # Set up Python environment
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    # Install Python dependencies
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install numpy scipy
    
    # Install C++ compiler
    - name: Install C++ compiler
      if: steps.detect-changes.outputs.source_changed == 'true'
      run: |
        sudo apt-get update
        sudo apt-get install -y g++ build-essential
    
    # Run combined validation
    - name: Run Combined Validation
      if: steps.detect-changes.outputs.source_changed == 'true'
      run: |
        cd codes/01_advDiffSolver
        python tests/run_validation.py
    
    # Summary
    - name: Validation Summary
      if: always()
      run: |
        echo ""
        echo "==================================================="
        echo "Grid Convergence Validation Complete"
        echo "==================================================="
        echo "Source files changed: ${{ steps.detect-changes.outputs.source_changed }}"

