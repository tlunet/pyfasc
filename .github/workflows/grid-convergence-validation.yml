name: Grid Convergence Validation

# Trigger the workflow on push and pull requests
on:
  push:
    branches: [ main, develop ]
    paths:
      - 'codes/01_advDiffSolver/src/**'
      - 'codes/01_advDiffSolver/tests/grid_convergence_validator.py'
      - '.github/workflows/grid-convergence-validation.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'codes/01_advDiffSolver/src/**'
      - 'codes/01_advDiffSolver/tests/grid_convergence_validator.py'
      - '.github/workflows/grid-convergence-validation.yml'

jobs:
  validate-grid-convergence:
    runs-on: ubuntu-latest
    
    steps:
    # Checkout the repository
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # Need 2 commits to check diff
    
    # Detect changed files in src/
    - name: Detect changed source files
      id: detect-changes
      run: |
        echo "Detecting changed files in src/ directory..."
        
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          # For PRs, compare against base branch
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep '^codes/01_advDiffSolver/src/' || true)
        else
          # For pushes, compare with previous commit
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep '^codes/01_advDiffSolver/src/' || true)
        fi
        
        echo "Changed files:"
        echo "$CHANGED_FILES"
        
        # Extract Python files
        PYTHON_FILES=$(echo "$CHANGED_FILES" | grep '\.py$' || true)
        # Extract C++ files
        CPP_FILES=$(echo "$CHANGED_FILES" | grep '\.cpp$' || true)
        # Extract Julia files
        JULIA_FILES=$(echo "$CHANGED_FILES" | grep '\.jl$' || true)
        
        # Set outputs
        if [ -n "$PYTHON_FILES" ]; then
          echo "python_changed=true" >> $GITHUB_OUTPUT
          echo "python_files<<EOF" >> $GITHUB_OUTPUT
          echo "$PYTHON_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          echo "python_changed=false" >> $GITHUB_OUTPUT
        fi
        
        if [ -n "$CPP_FILES" ]; then
          echo "cpp_changed=true" >> $GITHUB_OUTPUT
          echo "cpp_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CPP_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          echo "cpp_changed=false" >> $GITHUB_OUTPUT
        fi
        
        if [ -n "$JULIA_FILES" ]; then
          echo "julia_changed=true" >> $GITHUB_OUTPUT
          echo "julia_files<<EOF" >> $GITHUB_OUTPUT
          echo "$JULIA_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          echo "julia_changed=false" >> $GITHUB_OUTPUT
        fi
    
    # Set up Python environment
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    # Install Python dependencies
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install numpy scipy
    
    # Install C++ compiler
    - name: Install C++ compiler
      if: steps.detect-changes.outputs.cpp_changed == 'true'
      run: |
        sudo apt-get update
        sudo apt-get install -y g++ build-essential
    
    # Install Julia
    - name: Install Julia
      if: steps.detect-changes.outputs.julia_changed == 'true'
      uses: julia-actions/setup-julia@v1
      with:
        version: '1.9'
    
    # Validate Python files
    - name: Validate Python Grid Convergence
      if: steps.detect-changes.outputs.python_changed == 'true'
      working-directory: codes/01_advDiffSolver
      run: |
        echo "==================================================="
        echo "Testing Python implementations with Grid Convergence"
        echo "==================================================="
        
        EXIT_CODE=0
        while IFS= read -r file; do
          if [ -n "$file" ]; then
            echo ""
            echo "Testing: $file"
            echo "---------------------------------------------------"
            
            if python tests/grid_convergence_validator.py "$file" python; then
              echo "✅ PASSED: $file"
            else
              echo "❌ FAILED: $file"
              EXIT_CODE=1
            fi
          fi
        done <<< "${{ steps.detect-changes.outputs.python_files }}"
        
        exit $EXIT_CODE
    
    # Validate C++ files
    - name: Validate C++ Grid Convergence
      if: steps.detect-changes.outputs.cpp_changed == 'true'
      working-directory: codes/01_advDiffSolver
      run: |
        echo "==================================================="
        echo "Testing C++ implementations with Grid Convergence"
        echo "==================================================="
        
        EXIT_CODE=0
        while IFS= read -r file; do
          if [ -n "$file" ]; then
            echo ""
            echo "Testing: $file"
            echo "---------------------------------------------------"
            
            if python tests/grid_convergence_validator.py "$file" cpp; then
              echo "✅ PASSED: $file"
            else
              echo "❌ FAILED: $file"
              EXIT_CODE=1
            fi
          fi
        done <<< "${{ steps.detect-changes.outputs.cpp_files }}"
        
        exit $EXIT_CODE
    
    # Validate Julia files
    - name: Validate Julia Grid Convergence
      if: steps.detect-changes.outputs.julia_changed == 'true'
      working-directory: codes/01_advDiffSolver
      run: |
        echo "==================================================="
        echo "Testing Julia implementations with Grid Convergence"
        echo "==================================================="
        
        EXIT_CODE=0
        while IFS= read -r file; do
          if [ -n "$file" ]; then
            echo ""
            echo "Testing: $file"
            echo "---------------------------------------------------"
            
            if python tests/grid_convergence_validator.py "$file" julia; then
              echo "✅ PASSED: $file"
            else
              echo "❌ FAILED: $file"
              EXIT_CODE=1
            fi
          fi
        done <<< "${{ steps.detect-changes.outputs.julia_files }}"
        
        exit $EXIT_CODE
    
    # Summary
    - name: Validation Summary
      if: always()
      run: |
        echo ""
        echo "==================================================="
        echo "Grid Convergence Validation Complete"
        echo "==================================================="
        echo "Python files tested: ${{ steps.detect-changes.outputs.python_changed }}"
        echo "C++ files tested: ${{ steps.detect-changes.outputs.cpp_changed }}"
        echo "Julia files tested: ${{ steps.detect-changes.outputs.julia_changed }}"

